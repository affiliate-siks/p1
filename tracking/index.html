<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Landing</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 18px; }
    button { font-size: 18px; padding: 12px 16px; border-radius: 10px; border: 0; cursor: pointer; background:#111; color:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Landing</h1>
    <p>Klik vodi dalje.</p>
    <button id="cta" type="button">Nastavi</button>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby3dZE46rmHiyVcEGdNhoFaHN_w2fGuiTgpCRB_p_VDGVK44-aNypfgeYz0yzYlPeHcJA/exec";
    const SHEET_ID   = "1s9Lm83xDYoo3ilVoDyRs3GxNfjkyNpmzt427VD1h3oA";

    // PROMIJENI
    const REDIRECT_URL = "https://example.com/";

    function getOrCreateVisitorId() {
      const key = "visitor_id";
      let id = localStorage.getItem(key);
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
        localStorage.setItem(key, id);
      }
      return id;
    }

    function getUtm() {
      const u = new URL(window.location.href);
      return {
        utm_source:   u.searchParams.get("utm_source")   || "",
        utm_medium:   u.searchParams.get("utm_medium")   || "",
        utm_campaign: u.searchParams.get("utm_campaign") || "",
        utm_content:  u.searchParams.get("utm_content")  || "",
        utm_term:     u.searchParams.get("utm_term")     || ""
      };
    }

    function sendEvent(event_type) {
      const payload = {
        sheet_id: SHEET_ID,
        event_type,
        visitor_id: getOrCreateVisitorId(),
        landing_url: window.location.href,
        referrer: document.referrer || "",
        user_agent: navigator.userAgent || "",
        ...getUtm()
      };

      // sendBeacon is best for redirect/unload
      try {
        const blob = new Blob([JSON.stringify(payload)], { type: "text/plain;charset=utf-8" });
        navigator.sendBeacon(WEBAPP_URL, blob);
      } catch (e) {
        fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
          keepalive: true
        }).catch(()=>{});
      }
    }

    // page_view on load
    sendEvent("page_view");

    // click then redirect
    document.getElementById("cta").addEventListener("click", (e) => {
      e.preventDefault();
      sendEvent("click");
      // tiny delay makes it bulletproof across browsers
      setTimeout(() => { window.location.href = REDIRECT_URL; }, 150);
    });
  </script>
</body>
</html>
